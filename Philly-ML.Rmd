---
title: "Philly-ML"
author: "Emily Zhou"
date: "2023-10-03"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
library(sf)
library(tidyverse)
library(spdep)
library(caret)
library(ckanr)
library(FNN)
library(grid)
library(gridExtra)
library(ggcorrplot) # plot correlation plot
library(corrr)      # another way to plot correlation plot
library(kableExtra)
library(jtools)     # for regression model plots
library(ggstance) # to support jtools plots
library(ggpubr)    # plotting R^2 value on ggplot point scatter
library(broom.mixed) # needed for effects plots

source("https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/functions.r")


data <- st_read("/Users/emzhou/Documents/Fall2023/MUSA-PPA/Wk4/studentData.geojson")
training <- data %>% filter(toPredict != "CHALLENGE") %>% st_transform('ESRI:102728')
crime <- st_read("/Users/emzhou/Documents/GitHub/MUSA5080-Philly-ML/data/crime.geojson") %>% st_transform('ESRI:102728')
hospital <- st_read("https://raw.githubusercontent.com/emilyzhou112/MUSA5080-Philly-ML/main/data/Hospitals.geojson") %>% st_transform('ESRI:102728')
neighborhood <- st_read("/Users/emzhou/Documents/GitHub/MUSA5080-Philly-ML/data/neighborhood.geojson") %>% st_transform('ESRI:102728')

```


```{r process age and price}

tr_processed <- training %>% 
  mutate(Age = 2023 - year_built) %>% 
  filter(Age < 500) %>% 
  filter(sale_price < 2000000) %>% 
  mutate(numRooms = number_of_bedrooms + number_of_bathrooms) %>% 
  filter(numRooms < 30) %>% 
  filter(total_livable_area != 0 & is.na(total_area) == FALSE)
  
```

```{r process basement}
tr_processed <- tr_processed %>% 
   mutate(hasBasement = case_when(
    basements %in% c("1", "4", "A", "B", "C", "D", "E", "F") ~ "Y",
    TRUE~ "N"
  ))
  
```

```{r}

tr_processed <- tr_processed %>% 
  mutate(hasAC = case_when(
         central_air %in% c("1", "Y") ~ "Y",
         TRUE~ "N"),
         exterior = case_when(
         exterior_condition == 1 |exterior_condition == 2| exterior_condition == 3| exterior_condition == 4   ~ "Good",
         TRUE~ "Bad"),
         interior = case_when(
         interior_condition == 1 |interior_condition == 2| interior_condition == 3| interior_condition == 4   ~ "Good",
         TRUE~ "Bad"),
         hasFireplace = case_when(
         fireplaces == 0 | is.na(fireplaces)  ~ "N",
         TRUE~ "Y"),
         hasGarage = case_when(
         garage_type == 0 | is.na(garage_type)  ~ "N",
         TRUE~ "Y"),
         stories = case_when(
         number_stories == 1  ~ "single",
         number_stories == 2  ~ "double",
         TRUE~ "multiple"),
         area = case_when(
           total_livable_area > total_area ~ total_livable_area,  
           TRUE ~ total_area),
         hasHeater = case_when(
         type_heater == 0 | is.na(type_heater)  ~ "N",
         TRUE~ "Y"),
         view = case_when(
         view_type == "I" | view_type == "0" | is.na(view_type)   ~ "Typical",
         view_type == "A" | view_type == "B" | view_type == "C" ~ "Scenic",
         TRUE~ "Urban"), 
         quality = case_when(
         quality_grade %in% c("4", "5", "6", "A", "A+", "A-", "B", "B+","B-","S","S+","X-")  ~ "Good",
         TRUE~ "Bad"),
         buildingdis = case_when(
         grepl("ROW",building_code_description_new, ignore.case = FALSE) ~ "Row",
         grepl("TWIN",building_code_description_new, ignore.case = FALSE) ~ "TWIN",
         TRUE~ "Other")
  ) %>% 
  filter(area < 50000)
  
  
```



```{r}

tr_processed_reg <- tr_processed %>% st_drop_geometry()
reg1 <- lm(sale_price ~ ., data = tr_processed_reg %>% 
                                 dplyr::select(sale_price, Age, numRooms, hasBasement, hasAC, quality, buildingdis, 
                                               hasFireplace, hasGarage, stories, area, view))

summary(reg1)
```


```{r}

anova_result <- aov(tr_processed$sale_price ~ as.factor(tr_processed$building_code_description_new))
summary(anova_result)

```


```{r}
vif(reg1)
```



```{r}
residuals_df <- data.frame(Residuals = resid(reg3), Fitted = fitted(reg3))
ggplot(residuals_df, aes(x = Fitted, y = Residuals)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  labs(x = "Fitted Values", y = "Residuals", title = "Residual Plot")
```


```{r}

tr_neigh <- st_join(tr_processed, neighborhood %>% select(NAME))

```


```{r}

reg2 <- lm(sale_price ~ ., data = tr_neigh %>% st_drop_geometry() %>% 
                                 dplyr::select(sale_price, Age, numRooms, hasBasement, hasAC, quality, buildingdis, 
                                               hasFireplace, hasGarage, stories, area, view, NAME))

summary(reg2)
```
```{r}
vif(reg2)
```


```{r}
assault <- crime %>% 
  filter(text_gener == "Aggravated Assault Firearm" | text_gener == "Aggravated Assault No Firearm") %>% 
  dplyr::select(point_x, point_y) %>%
    na.omit()

tr_neigh <-
  tr_neigh %>% 
    mutate(crime_nn3 = nn_function(st_coordinates(tr_neigh), 
                              st_coordinates(assault), k = 3))
tr_neigh$crimes.Buffer <- tr_neigh %>% 
    st_buffer(660) %>% 
    aggregate(mutate(assault, counter = 1),., sum) %>%
    pull(counter)
```


```{r}
schools <- st_read("/Users/emzhou/Documents/GitHub/MUSA5080-Philly-ML/data/school.geojson") %>% 
  filter(GRADE_ORG == "K-12" | GRADE_ORG == "9-12") %>%  
  filter(TYPE_SPECIFIC == "PRIVATE") %>% 
  st_transform('ESRI:102728')


tr_neigh <-
  tr_neigh %>% 
    mutate(schools_nn1 = nn_function(st_coordinates(tr_neigh), 
                              st_coordinates(schools), k = 1))

```


```{r}

tr_neigh <-
  tr_neigh %>% 
    mutate(hospitals_nn1 = nn_function(st_coordinates(tr_neigh), 
                              st_coordinates(hospital), k = 1))
```


```{r}
el <- st_read("https://opendata.arcgis.com/datasets/8c6e2575c8ad46eb887e6bb35825e1a6_0.geojson")
Broad_St <- st_read("https://opendata.arcgis.com/datasets/2e9037fd5bef406488ffe5bb67d21312_0.geojson")

septaStops <- 
  rbind(
     el %>% 
      mutate(Line = "El") %>%
      dplyr::select(Station, Line),
     Broad_St %>%
      mutate(Line ="Broad_St") %>%
      dplyr::select(Station, Line)) %>%
  st_transform('ESRI:102728')
  

test <- tr_neigh %>% 
  st_intersection(st_buffer(septaStops, 3000)) %>% 
  st_drop_geometry() %>% 
  group_by(parcel_number) %>% 
  summarize(
    totalstops = n())

tr_neigh <- tr_neigh %>% 
  left_join(test, by = "parcel_number") %>% 
  
tr_neigh <- tr_neigh %>% 
  mutate(totalstops = ifelse(is.na(totalstops), 0, totalstops))
  
```


```{r}
summary(tr_neigh$Age)
hist(tr_neigh$numRooms, main = "Histogram", xlab = "Variable Name")
  
tr_neigh$logarea <- log(tr_neigh$area)
#tr_neigh$logcrimes <- log(tr_neigh$crimes.Buffer)
#tr_neigh$logschool <- log(tr_neigh$schools_nn1)
#tr_neigh$logrooms <- log(tr_neigh$numRooms)

#tr_neigh <- tr_neigh %>% 
  #mutate(logrooms = ifelse(is.infinite(logrooms), 0, logrooms))

```


```{r}
reg3 <- lm(sale_price ~ ., data = tr_neigh %>% st_drop_geometry() %>% 
                                 dplyr::select(sale_price, Age, numRooms, hasBasement, hasAC, quality, buildingdis, 
                                               hasFireplace, hasGarage, stories, logarea, view, NAME, crimes.Buffer, totalstops, hospitals_nn1, schools_nn1))
summary(reg3)
```


```{r}
vif(reg3)
```


```{r}
set.seed(244) # 40
inTrain <- createDataPartition(
   y = paste(tr_neigh$NAME, tr_neigh$hasBasement, tr_neigh$hasAC, tr_neigh$quality, tr_neigh$buildingdis, tr_neigh$hasFireplace, tr_neigh$hasGarage, tr_neigh$stories, tr_neigh$view
                        ),
              p = .60, list = FALSE)

tr_neigh.training <- tr_neigh[inTrain,] 
tr_neigh.test <- tr_neigh[-inTrain,]  

reg.train <- lm(sale_price ~ ., data = tr_neigh.training %>% st_drop_geometry() %>% 
                                 dplyr::select(sale_price, Age, numRooms, hasBasement, hasAC, quality, buildingdis, 
                                               hasFireplace, hasGarage, stories, logarea, view, NAME, crimes.Buffer, totalstops, hospitals_nn1, schools_nn1))

tr_neigh.test <- tr_neigh.test %>% 
  filter(NAME %in% c("BLUE BELL HILL", "BYBERRY", "HUNTING PARK INDUSTRIAL AREA", "SHAWMONT VALLEY", "NORMANDY") == FALSE)


tr_neigh.test <- 
  tr_neigh.test %>% 
  mutate(SalePrice.Predict = predict(reg.train, tr_neigh.test),
         SalePrice.Error = SalePrice.Predict - sale_price,
         SalePrice.AbsError = abs(SalePrice.Predict - sale_price),
         SalePrice.APE = (abs(SalePrice.Predict - sale_price)) / SalePrice.Predict)

```


```{r}
mean(tr_neigh.test$SalePrice.APE, na.rm = T)

```


```{r}
summary(reg.train)
```


```{r}
options(tigris_class = "sf")
library(tidycensus)
library(svDialogs)
census_api_key(dlgInput(
  "Enter a Census API Key", # ask for an api key
  Sys.getenv("CENSUS_API_KEY")
)$res,
overwrite = TRUE)


tracts20 <- 
  get_acs(geography = "tract", 
          variables = c("B02001_001E", # total population
            "B02001_002E", # white population
            "B02001_003E", # black population
            "B02001_005E", # asian population
            "B03002_012E"), 
          year=2020, state=42, county=101, 
          geometry=TRUE, output="wide") %>%
  st_transform('ESRI:102728') %>% 
  rename(TotalPop = B02001_001E, 
         Whites = B02001_002E,
         African_Americans = B02001_003E,
         Asians = B02001_005E,
         Latinx = B03002_012E) %>% 
  mutate(pctMinority = ifelse(TotalPop > 0, (African_Americans + Asians + Latinx ) / TotalPop, 0))
  
```









## Getis Ord


```{r}

tract <- st_read("/Users/emzhou/Documents/GitHub/MUSA5080-Philly-ML/data/Census_Blocks_2010.geojson") %>% st_transform('ESRI:102728')

tr_tract <- st_join(tr_processed, tract %>% select(GEOID10))

gi_data <- tr_tract %>% 
  st_drop_geometry() %>% 
  select(GEOID10, sale_price) %>% 
  group_by(GEOID10) %>% 
  summarize(mean_sp = mean(sale_price)) %>% 
  na.omit() %>% 
  left_join(tract) %>% 
  st_sf()

gi_data <- gi_data %>% 
  st_make_valid()

```

```{r}

list_nb <- poly2nb(gi_data, queen = TRUE)


empty_nb <- which(card(list_nb) == 0)
empty_nb   

gi_subset <- gi_data[-empty_nb, ]

neigh_nbs <- gi_subset %>% 
  mutate(
    nb = st_contiguity(geometry),        # neighbors share border/vertex
    wt = st_weights(nb),                 # row-standardized weights
    neigh_lag = st_lag(mean_sp, nb, wt)    # calculate spatial lag of TreEqty
  )

gi_hot_spots <- neigh_nbs %>% 
  mutate(
    Gi = local_g_perm(mean_sp, nb, wt, nsim = 999)
    # nsim = number of Monte Carlo simulations (999 is default)
  ) %>% 
  unnest(Gi) 


```



```{r}
gi_hot_spots |> 
  ggplot((aes(fill = gi))) +
  geom_sf(color = NA) +
scale_fill_gradient2()  + theme_dark()
```



```{r}
tr_neigh %>% 
  ggplot(aes(x = buildingdis)) +
  geom_bar() +
  labs(title = "Histogram Example", x = "X-Axis Label", y = "Frequency")
```

```{r}
tr_neigh.test %>% 
  group_by(NAME) %>% 
  summarise(count = n()) %>% 
  filter(count == 1)
```


```{r}
summary(tr_processed$off_street_open)
```

